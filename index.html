<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LH Invoice PWA</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 10px; background: #fff; }
        form { max-width: 800px; margin: auto; }
        label { display: block; margin: 10px 0; }
        input, select, textarea { width: 100%; padding: 8px; box-sizing: border-box; }
        button { padding: 10px; margin: 5px 0; }
        #items { margin: 20px 0; }
        .item-row { display: grid; grid-template-columns: 3fr 1fr 1fr 1fr; gap: 10px; margin: 10px 0; }
        #invoicePreview { max-width: 800px; margin: auto; padding: 20px; border: 1px solid #ccc; display: none; font-size: 14px; }
        .header { background: #b0a295; padding: 10px; text-align: center; color: #fff; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 24px; font-weight: bold; }
        .supplier { text-align: right; font-size: 12px; }
        .info-row { display: flex; justify-content: space-between; margin: 10px 0; }
        .billed-to { margin: 20px 0; }
        .items-table { width: 100%; border-collapse: collapse; }
        .items-table th { background: #b0a295; color: #fff; padding: 5px; text-align: left; }
        .items-table td { border-bottom: 1px solid #ddd; padding: 5px; }
        .totals { text-align: right; margin: 20px 0; }
        .totals div { background: #f9f9f9; padding: 5px; width: 200px; margin-left: auto; }
        .payment { display: flex; justify-content: space-between; margin: 20px 0; }
        .note { text-align: center; font-size: 12px; }
        @media (max-width: 600px) { .item-row { grid-template-columns: 1fr; } }
        @media print { #formSection { display: none; } #invoicePreview { display: block; border: none; } }
    </style>
    <script>
        if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js'));
    </script>
</head>
<body>
    <h1>LH Ventures Invoice Generator</h1>
    <section id="formSection">
        <form id="invoiceForm">
            <label>Invoice No.: <select name="invoiceNo" id="invoiceNoSelect"></select> <button type="button" onclick="addOption('invoiceNo')">Add New</button></label>
            <label>Date: <select name="date" id="dateSelect" type="date"></select> <button type="button" onclick="addOption('date')">Add New</button></label>
            <label>Billed To Name: <select name="billedToName" id="billedToNameSelect"></select> <button type="button" onclick="addOption('billedToName')">Add New</button></label>
            <label>Billed To Address: <textarea name="billedToAddress" id="billedToAddressInput"></textarea></label>
            <div id="items">
                <h3>Items</h3>
                <div class="item-row">
                    <select class="item-desc"></select>
                    <select class="item-qty"></select>
                    <select class="item-unit"></select>
                    <input class="item-total" readonly>
                </div>
                <button type="button" id="addItem">Add Item</button>
            </div>
            <label>Discount (RM): <select name="discount" id="discountSelect"></select> <button type="button" onclick="addOption('discount')">Add New</button></label>
            <label>Due Date: <input name="dueDate" type="date" value="2026-01-19"></label>
            <button type="submit">Generate Invoice</button>
            <button type="button" id="downloadPDF">Download PDF</button>
            <button type="button" id="clearForm">Clear Form</button>
        </form>
    </section>
    <section id="invoicePreview">
        <div class="header">
            <div class="logo">Sales Invoice LH</div>
            <div class="supplier">LH Ventures<br>B-02-03, Blok B, Residensi Lili,<br>71800, Nilai, Negeri Sembilan</div>
        </div>
        <div class="info-row">
            <span>Invoice No. <span id="prevInvoiceNo"></span></span>
            <span>Date <span id="prevDate"></span></span>
        </div>
        <div class="billed-to">
            Billed to <span id="prevBilledName"></span><br>
            <span id="prevBilledAddress"></span>
        </div>
        <table class="items-table">
            <thead><tr><th>Item</th><th>Quantity</th><th>Unit Price</th><th>Total Amount</th></tr></thead>
            <tbody id="prevItems"></tbody>
        </table>
        <div class="totals">
            <div>Subtotal <span id="prevSubtotal"></span></div>
            <div>Discount <span id="prevDiscount"></span></div>
            <div style="background: #b0a295; color: #fff;">Grand Total <span id="prevGrandTotal"></span></div>
        </div>
        <div class="payment">
            <div>Please settle your payment on or before: <span id="prevDueDate"></span></div>
            <div>Bank Name: Maybank<br>Account Name: LH Ventures<br>Account Number: 555087234884</div>
        </div>
        <div class="note">We appreciate your business! 1% of each invoice will be donated to our local orphanage.</div>
    </section>
    <script>
        const form = document.getElementById('invoiceForm');
        const preview = document.getElementById('invoicePreview');
        const storageKeys = ['invoiceNo', 'date', 'billedToName', 'discount', 'items'];
        const storage = {};

        storageKeys.forEach(key => {
            storage[key] = JSON.parse(localStorage.getItem(key)) || [];
            updateSelect(key);
        });

        function updateSelect(key) {
            const select = document.getElementById(`${key}Select`);
            if (select) {
                select.innerHTML = storage[key].map(val => `<option>${val}</option>`).join('');
                select.addEventListener('change', () => {
                    if (key === 'billedToName') {
                        // Assume addresses stored separately or same, adjust if needed
                        document.getElementById('billedToAddressInput').value = storage['billedToAddress']?.[storage[key].indexOf(select.value)] || '';
                    }
                });
            }
        }

        function addOption(key) {
            const val = prompt(`Add new ${key}:`);
            if (val) {
                storage[key].push(val);
                localStorage.setItem(key, JSON.stringify(storage[key]));
                updateSelect(key);
            }
        }

        function addItemRow() {
            const row = document.createElement('div');
            row.className = 'item-row';
            row.innerHTML = `
                <select class="item-desc">\( {storage.items?.map(i => `<option> \){i.desc}</option>`).join('') || ''}</select>
                <input class="item-qty" type="number" placeholder="Quantity">
                <input class="item-unit" type="number" step="0.01" placeholder="Unit Price (RM)">
                <input class="item-total" readonly placeholder="Total">
                <button type="button" onclick="this.parentNode.remove(); calculateTotals();">Remove</button>
            `;
            document.getElementById('items').insertBefore(row, document.getElementById('addItem'));
            row.querySelector('.item-qty').addEventListener('input', calculateRow);
            row.querySelector('.item-unit').addEventListener('input', calculateRow);
        }

        function calculateRow(e) {
            const row = e.target.closest('.item-row');
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const unit = parseFloat(row.querySelector('.item-unit').value) || 0;
            row.querySelector('.item-total').value = (qty * unit).toFixed(2);
            calculateTotals();
        }

        function calculateTotals() {
            let subtotal = 0;
            document.querySelectorAll('.item-total').forEach(t => subtotal += parseFloat(t.value) || 0);
            const discount = parseFloat(form.discount.value) || 0;
            document.getElementById('prevSubtotal').textContent = `RM${subtotal.toFixed(2)}`;
            document.getElementById('prevDiscount').textContent = `RM${discount.toFixed(2)}`;
            document.getElementById('prevGrandTotal').textContent = `RM${(subtotal - discount).toFixed(2)}`;
        }

        document.getElementById('addItem').addEventListener('click', addItemRow);
        addItemRow(); addItemRow(); // Defaults

        form.addEventListener('submit', e => {
            e.preventDefault();
            const data = new FormData(form);
            document.getElementById('prevInvoiceNo').textContent = data.get('invoiceNo');
            document.getElementById('prevDate').textContent = new Date(data.get('date')).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'});
            document.getElementById('prevBilledName').textContent = data.get('billedToName');
            document.getElementById('prevBilledAddress').textContent = data.get('billedToAddress').replace(/\n/g, '<br>');
            document.getElementById('prevDueDate').textContent = new Date(data.get('dueDate')).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'});
            const itemsBody = document.getElementById('prevItems');
            itemsBody.innerHTML = '';
            document.querySelectorAll('.item-row').forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>\( {row.querySelector('.item-desc').value}</td><td> \){row.querySelector('.item-qty').value}</td><td>RM\( {parseFloat(row.querySelector('.item-unit').value).toFixed(2)}</td><td>RM \){row.querySelector('.item-total').value}</td>`;
                itemsBody.appendChild(tr);
            });
            calculateTotals();
            preview.style.display = 'block';
            window.scrollTo(0, preview.offsetTop);
        });

        document.getElementById('downloadPDF').addEventListener('click', () => {
            if (preview.style.display === 'none') return alert('Generate first');
            html2canvas(preview, {scale: 2}).then(canvas => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, 297);
                doc.save(`invoice_${form.invoiceNo.value}.pdf`);
            });
        });

        document.getElementById('clearForm').addEventListener('click', () => form.reset());
    </script>
</body>
</html>